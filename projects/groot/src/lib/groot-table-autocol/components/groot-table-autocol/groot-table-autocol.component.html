<groot-table
  [downloadExcelLabel]="downloadExcelLabel"
  [downloadExcelUrl]="downloadExcelUrl"
  [downloadExcelUrlProvider]="downloadExcelUrlProvider"
  [downloadExcelArgs]="downloadExcelArgs"
  [defaultSortColumn]="defaultSortColumn"
  [defaultSortReverseFlag]="defaultSortReverseFlag"
  [pageSize]="pageSize"
  [tableClassName]="tableClassName"
  [tHeadClassName]="tHeadClassName"
  [hideTableIfEmpty]="hideTableIfEmpty"
  (search)="onSearch($event)"
  [searchResultsData]="searchResultsData"
  [striped]="false"
  #grootTable
>
  <ng-template grootTableTitleRightArea>
    <groot-button
      label="common.selectColumns"
      classes="btn-outline-primary"
      icon="fa fa-list"
      (click)="selectColumns()"
      class="mb-2"
    ></groot-button>
  </ng-template>

  <ng-template grootTableHeader>
    <tr cdkDropList
        cdkDropListLockAxis="x"
        cdkDropListOrientation="horizontal"
        (cdkDropListDropped)="moveColumn($event)">
      <th *ngFor="let column of selectedColumns"
          cdkDrag
          class="groot-table-header-draggable"
          [ngStyle]="{'width.px': column.widthPx ? '' + column.widthPx : null, 'min-width.px': column.widthPx ? '' + column.widthPx : null}">
        <div class="groot-table-header-filter-icon"
             [popover]="filterTemplate"
             containerClass="popover-filters"
             placement="auto"
             container="body"
             [outsideClick]="true"
             [popoverContext]="{column: column}"
             (onShown)="onPopoverShow(column)"
             [class.active]="filterPopoverValues[column.key] && filterPopoverValues[column.key].length">
          <i class="fa fa-filter"></i>
        </div>

        <groot-table-header [label]="column.label"
                            [columnName]="column.columnName"
                            [icon]="column.icon"
        ></groot-table-header>

        <div class="drag-drop-indicator"
             (mousedown)="onStartResizingColumn($event, column)"
        ></div>
      </th>
      <th class="table-accordion-col" *ngIf="accordionColumns.length > 0">&nbsp;</th>
    </tr>
  </ng-template>

  <ng-template grootTableBody let-searchResults>
    <ng-container *ngFor="let row of searchResults.records">
      <!-- Row -->
      <tr [ngClass]="trClassName"
          [class.table-row-selectable]="accordionColumns.length > 0"
          (click)="row.$accordionVisible = !row.$accordionVisible">
        <td *ngFor="let column of selectedColumns"
            [ngClass]="column.tdClassName">
          <ng-template
            [ngTemplateOutlet]="column.customTemplate || defaultFieldTemplate"
            [ngTemplateOutletContext]="{row: row, column: column, value: row[column.fieldName], $implicit: row[column.fieldName]}"
          ></ng-template>
        </td>
        <td *ngIf="accordionColumns.length > 0">
          <groot-accordion-indicator [row]="row"></groot-accordion-indicator>
        </td>
      </tr>

      <!-- Accordion -->
      <tr *ngIf="row.$accordionVisible"
          [@dropDown]>
        <td [attr.colspan]="selectedColumns.length + 1">
          <div class="container-fluid">
            <div class="row">
              <div class="col-sm-6 col-md-4 col-lg-3 mb-2"
                   *ngFor="let column of accordionColumns">
                <div><b>{{column.label | translate}}</b></div>
                <ng-template
                  [ngTemplateOutlet]="column.customTemplate || defaultFieldTemplate"
                  [ngTemplateOutletContext]="{row: row, column: column, value: row[column.fieldName], $implicit: row[column.fieldName]}"
                ></ng-template>
              </div>
            </div>
          </div>
        </td>
      </tr>
    </ng-container>
  </ng-template>

  <ng-template #defaultFieldTemplate let-value="value" let-column="column">
    <ng-container [ngSwitch]="column.columnType">
      <ng-container *ngSwitchCase="NbpuSchemaFieldType.DATE">
        {{value| date: 'dd/MM/yyyy'}}
      </ng-container>
      <ng-container *ngSwitchCase="NbpuSchemaFieldType.TIMESTAMP">
        {{value| date: 'dd/MM/yyyy'}}
        <small>{{value| date: 'HH:mm'}}</small>
      </ng-container>
      <ng-container *ngSwitchCase="NbpuSchemaFieldType.TIME">
        {{value| date: 'HH:mm'}}
      </ng-container>
      <div *ngSwitchCase="NbpuSchemaFieldType.DOUBLE" class="text-right">
        {{value | number: '0.2'}}
      </div>
      <div *ngSwitchCase="NbpuSchemaFieldType.INT32" class="text-right">
        {{value | number: '0.0'}}
      </div>
      <div *ngSwitchCase="NbpuSchemaFieldType.INT64" class="text-right">
        {{value | number: '0.0'}}
      </div>
      <ng-container *ngSwitchDefault>{{value}}</ng-container>
    </ng-container>
  </ng-template>

  <ng-template #filterTemplate let-column="column">
    <ng-container *ngIf="filterPopoverDomain[column.key]; else filterLoadingTemplate">
      <groot-combo-checkbox
        name="filter-column"
        placeholder="common.filter"
        [showAsListBox]="true"
        [items]="filterPopoverDomain[column.key]"
        [(ngModel)]="filterPopoverTempValues[column.key]"
      ></groot-combo-checkbox>
    </ng-container>
    <ng-template #filterLoadingTemplate>
      <div class="loading-indicator">
        <i class="fa fa-spin fa-spinner"></i>
        {{'common.loading' | translate}}
      </div>
    </ng-template>

    <div class="buttons-list-bottom-right">
      <groot-button
        classes="btn-outline-danger"
        icon="fa fa-cross"
        label="common.cancel"
        (click)="closePopoverFilter()"
      ></groot-button>

      <groot-button
        classes="btn-success"
        icon="fa fa-filter"
        label="common.apply"
        (click)="applyPopoverFilter(column)"
      ></groot-button>
    </div>
  </ng-template>
</groot-table>

<div class="resizing-col-indicator" #resizingColIndicator></div>
