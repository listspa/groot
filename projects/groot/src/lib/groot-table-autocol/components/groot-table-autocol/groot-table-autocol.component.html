<groot-table
  [downloadExcelLabel]="downloadExcelLabel"
  [downloadExcelUrl]="downloadExcelUrl"
  [downloadExcelUrlProvider]="downloadExcelUrlProvider"
  [downloadExcelArgs]="downloadExcelArgs"
  [defaultSortColumn]="defaultSortColumn"
  [defaultSortReverseFlag]="defaultSortReverseFlag"
  [pageSize]="pageSize"
  [tableClassName]="tableClassName"
  [tHeadClassName]="tHeadClassName"
  [hideTableIfEmpty]="hideTableIfEmpty"
  (search)="onSearch($event)"
  [searchResultsData]="searchResultsData"
  [striped]="false"
  #grootTable
>
  <ng-template grootTableTitleRightArea>
    <ng-container *ngIf="autocolTableTitleRightArea">
      <ng-container *ngTemplateOutlet="autocolTableTitleRightArea"></ng-container>
    </ng-container>

    <groot-button
      label="common.selectColumns"
      classes="btn-outline-primary"
      icon="fa fa-list"
      (click)="selectColumns()"
      class="mb-2"
    ></groot-button>
  </ng-template>

  <ng-template grootTableHeader>
    <tr cdkDropList
        cdkDropListLockAxis="x"
        cdkDropListOrientation="horizontal"
        (cdkDropListDropped)="moveColumn($event)">
      <th *ngIf="actionsTemplate" class="table-actions-col">&nbsp;</th>
      <th *ngFor="let column of selectedColumns"
          cdkDrag
          class="groot-table-header-draggable"
          [ngStyle]="{'width.px': column.widthPx ? '' + column.widthPx : null, 'min-width.px': column.widthPx ? '' + column.widthPx : null}">

        <!-- Filters -->
        <div *ngIf="column.showFilters"
             class="groot-table-header-filter-icon"
             [class.active]="filterPopoverValues[column.key] && filterPopoverValues[column.key].length"
             (click)="showFilterPopover(column, $event)"
             [attr.title]="'common.filter' | translate">
          <i class="fa fa-filter"></i>
        </div>

        <groot-table-header [label]="column.label"
                            [columnName]="column.columnName"
                            [icon]="column.icon"
                            [class.groot-table-header-after-filters]="column.showFilters"
        ></groot-table-header>

        <div class="drag-drop-indicator"
             (mousedown)="onStartResizingColumn($event, column)"
        ></div>
      </th>
      <th class="table-accordion-col" *ngIf="accordionColumns.length > 0">&nbsp;</th>
    </tr>
  </ng-template>

  <ng-template grootTableBody let-searchResults>
    <ng-container *ngFor="let row of searchResults.records">
      <!-- Row -->
      <tr [ngClass]="trClassName"
          [class.table-row-selectable]="accordionColumns.length > 0"
          [class.accordion-expanded]="row.$accordionVisible"
          (click)="row.$accordionVisible = !row.$accordionVisible">
        <!-- Actions button -->
        <td *ngIf="actionsTemplate">
          <groot-actions-button
            [insideTable]="true"
            [popoverTemplate]="actionsTemplate"
            [popoverContext]="{row: row, $implicit: row}"
            (click)="$event.stopPropagation()"
          ></groot-actions-button>
        </td>

        <!-- Fields -->
        <td *ngFor="let column of selectedColumns"
            [ngClass]="column.tdClassName">
          <ng-template
            [ngTemplateOutlet]="column.customTemplate || defaultFieldTemplate"
            [ngTemplateOutletContext]="{row: row, column: column, value: row[column.fieldName], $implicit: row[column.fieldName]}"
          ></ng-template>
        </td>

        <!-- Accordion button -->
        <td *ngIf="accordionColumns.length > 0">
          <groot-accordion-indicator [row]="row"></groot-accordion-indicator>
        </td>
      </tr>

      <!-- Accordion -->
      <tr *ngIf="row.$accordionVisible"
          class="accordion-row"
          [@dropDown]>
        <td [attr.colspan]="selectedColumns.length + 1 + (actionsTemplate ? 1 : 0)"
            class="accordion-container">
          <div class="container-fluid accordion-content">
            <div class="row">
              <div class="col-sm-6 col-md-4 col-lg-3 mb-2"
                   *ngFor="let column of accordionColumns">
                <div><b>{{column.label | translate}}</b></div>
                <ng-template
                  [ngTemplateOutlet]="column.customTemplate || defaultFieldTemplate"
                  [ngTemplateOutletContext]="{row: row, column: column, value: row[column.fieldName], $implicit: row[column.fieldName]}"
                ></ng-template>
              </div>
            </div>
          </div>
        </td>
      </tr>
    </ng-container>
  </ng-template>

  <ng-template #defaultFieldTemplate let-value="value" let-column="column">
    <groot-display-label-value
      [value]="value"
      [dataType]="column.columnType"
    ></groot-display-label-value>
  </ng-template>
</groot-table>

<div class="resizing-col-indicator" #resizingColIndicator></div>
